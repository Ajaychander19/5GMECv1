version: '3.8'

services:
  mysql:
    container_name: oai-mysql
    image: mysql:8.0
    volumes:
      - ./database/oai_db.sql:/docker-entrypoint-initdb.d/oai_db.sql
    environment:
      - MYSQL_ROOT_PASSWORD=linux
      - MYSQL_DATABASE=oai_db
      - MYSQL_USER=oai_user
      - MYSQL_PASSWORD=oai_password
    networks:
      5g_core_net:
        ipv4_address: 172.30.0.30
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    labels:
      project: 5g-oai-research-platform
      component: core
      service: mysql

  oai-nrf:
    container_name: oai-nrf
    image: oaisoftwarealliance/oai-nrf:v2.1.0
    environment:
      - NF_NAME=OAI-NRF
      - NRF_INTERFACE_NAME_FOR_SBI=eth0
      - NRF_INTERFACE_PORT_FOR_SBI=8080
      - NF_REGISTRATION=no
      - NF_DISCOVERY=no
      - LOG_LEVEL=debug
    networks:
      5g_core_net:
        ipv4_address: 172.30.0.20
    ports:
      - "8080:8080"
    depends_on:
      - mysql
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/nnrf-nfm/v1/nf-instances"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      project: 5g-oai-research-platform
      component: core
      service: nrf

  oai-udr:
    container_name: oai-udr
    image: oaisoftwarealliance/oai-udr:v2.1.0
    environment:
      - NF_NAME=OAI-UDR
      - NF_REGISTRATION=yes
      - NRF_IPV4_ADDRESS=172.30.0.20
      - NRF_PORT=8080
      - MYSQL_IPV4_ADDRESS=172.30.0.30
      - MYSQL_DB=oai_db
      - MYSQL_USER=oai_user
      - MYSQL_PASS=oai_password
      - UDR_INTERFACE_NAME_FOR_SBI=eth0
      - UDR_INTERFACE_PORT_FOR_SBI=8080
      - LOG_LEVEL=debug
    networks:
      5g_core_net:
        ipv4_address: 172.30.0.40
    depends_on:
      - mysql
      - oai-nrf
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/stats"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      project: 5g-oai-research-platform
      component: core
      service: udr

  oai-udm:
    container_name: oai-udm
    image: oaisoftwarealliance/oai-udm:v2.1.0
    environment:
      - NF_NAME=OAI-UDM
      - NF_REGISTRATION=yes
      - NRF_IPV4_ADDRESS=172.30.0.20
      - NRF_PORT=8080
      - UDR_IPV4_ADDRESS=172.30.0.40
      - UDR_PORT=8080
      - UDM_INTERFACE_NAME_FOR_SBI=eth0
      - UDM_INTERFACE_PORT_FOR_SBI=8080
      - LOG_LEVEL=debug
    networks:
      5g_core_net:
        ipv4_address: 172.30.0.45
    depends_on:
      - oai-udr
      - oai-nrf
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/stats"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      project: 5g-oai-research-platform
      component: core
      service: udm

  oai-ausf:
    container_name: oai-ausf
    image: oaisoftwarealliance/oai-ausf:v2.1.0
    environment:
      - NF_NAME=OAI-AUSF
      - NF_REGISTRATION=yes
      - NRF_IPV4_ADDRESS=172.30.0.20
      - NRF_PORT=8080
      - UDM_IPV4_ADDRESS=172.30.0.45
      - UDM_PORT=8080
      - AUSF_INTERFACE_NAME_FOR_SBI=eth0
      - AUSF_INTERFACE_PORT_FOR_SBI=8080
      - LOG_LEVEL=debug
    networks:
      5g_core_net:
        ipv4_address: 172.30.0.60
    depends_on:
      - oai-udm
      - oai-nrf
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/stats"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      project: 5g-oai-research-platform
      component: core
      service: ausf

  oai-amf:
    container_name: oai-amf
    image: oaisoftwarealliance/oai-amf:v2.1.0
    environment:
      - NF_NAME=OAI-AMF
      - NF_REGISTRATION=yes
      - NRF_IPV4_ADDRESS=172.30.0.20
      - NRF_PORT=8080
      - MYSQL_IPV4_ADDRESS=172.30.0.30
      - MYSQL_DB=oai_db
      - MYSQL_USER=oai_user
      - MYSQL_PASS=oai_password
      - MCC=208
      - MNC=95
      - REGION_ID=128
      - AMF_SET_ID=1
      - SERVED_GUAMI_MCC_0=208
      - SERVED_GUAMI_MNC_0=95
      - SERVED_GUAMI_REGION_ID_0=128
      - SERVED_GUAMI_AMF_SET_ID_0=1
      - PLMN_SUPPORT_MCC=208
      - PLMN_SUPPORT_MNC=95
      - PLMN_SUPPORT_SST=1
      - PLMN_SUPPORT_SD=0xffffff
      - AMF_INTERFACE_NAME_FOR_N1=eth0
      - AMF_INTERFACE_NAME_FOR_N11=eth0
      - AMF_INTERFACE_PORT_FOR_N1=38412
      - AMF_INTERFACE_PORT_FOR_N11=8080
      - SMF_IPV4_ADDRESS=172.30.0.50
      - SMF_PORT=8080
      - LOG_LEVEL=debug
    networks:
      5g_core_net:
        ipv4_address: 172.30.0.100
    ports:
      - "38412:38412/sctp"
    depends_on:
      - oai-nrf
      - mysql
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/stats"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      project: 5g-oai-research-platform
      component: core
      service: amf

  oai-smf:
    container_name: oai-smf
    image: oaisoftwarealliance/oai-smf:v2.1.0
    environment:
      - NF_NAME=OAI-SMF
      - NF_REGISTRATION=yes
      - NRF_IPV4_ADDRESS=172.30.0.20
      - NRF_PORT=8080
      - UPF_IPV4_ADDRESS=172.30.0.70
      - UPF_FQDN=oai-upf
      - UPF_PORT=8805
      - MCC=208
      - MNC=95
      - REGION_ID=128
      - AMF_SET_ID=1
      - SERVED_DNNAI_SST_0=1
      - SERVED_DNNAI_SD_0=0xffffff
      - DNN_NI0=oai
      - TYPE0=IPv4
      - DNN_RANGE0=12.1.1.0/24
      - REGISTER_NTF=yes
      - DISCOVER_UPF=yes
      - AMF_IPV4_ADDRESS=172.30.0.100
      - AMF_PORT=8080
      - SMF_INTERFACE_NAME_FOR_N4=eth0
      - SMF_INTERFACE_NAME_FOR_SBI=eth0
      - SMF_INTERFACE_PORT_FOR_N4=8805
      - SMF_INTERFACE_PORT_FOR_SBI=8080
      - LOG_LEVEL=debug
    networks:
      5g_core_net:
        ipv4_address: 172.30.0.50
    depends_on:
      - oai-nrf
      - oai-amf
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/stats"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      project: 5g-oai-research-platform
      component: core
      service: smf

  oai-upf:
    container_name: oai-upf
    image: oaisoftwarealliance/oai-upf:v2.1.0
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    volumes:
      - ./configs/upf.yaml:/openair-upf/etc/config.yaml:ro
    networks:
      5g_core_net:
        ipv4_address: 172.30.0.70
    depends_on:
      - oai-nrf
      - oai-smf
    labels:
      project: 5g-oai-research-platform
      component: core
      service: upf

networks:
  5g_core_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
          gateway: 172.30.0.1
    name: 5g-core-net
